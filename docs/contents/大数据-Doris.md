# Doris

Apache Doris 是一个现代化的分布式 SQL 数据库，专为实时分析而设计。它结合了 MPP（大规模并行处理）架构与列式存储技术，旨在提供高性能的数据查询能力，同时支持高并发的写入操作。Doris 的前身是 Palo，由百度开源，并于 2022 年正式加入 Apache 软件基金会成为顶级项目。

## 历史

1. **起源与早期发展**
   
   Apache Doris最早是诞生于百度广告报表业务的Palo项目。
   
   随着百度业务的飞速发展，该系统进行了多次迭代，逐渐承担起百度内部业务的统计报表和多维分析需求。
   
   2013年，百度把Doris进行了MPP（Massively Parallel Processing，大规模并行处理）框架的升级，并将新系统命名为Palo。

2. **开源与Apache孵化**
   
   2017年，百度以Palo的名字在GitHub上进行了开源，这使得更多的开发者能够接触到并参与到Doris的发展中来。
   
   2018年7月，百度将Doris捐赠给Apache基金会进行孵化。在Apache导师的指导下，由孵化器项目管理委员会成员进行孵化和运营。由于与国外数据库厂商重名，因此选择用回最初的名字Doris，这就是Apache Doris的由来。

3. **成长与壮大**
   
   自开源和加入Apache基金会以来，Apache Doris社区不断发展壮大。社区已经聚集了来自不同行业数百家企业的贡献者，数量持续增长。
   
   2022年6月，Apache Doris成功从Apache孵化器毕业，正式成为Apache顶级项目（Top-Level Project，TLP）。

## 基本特性

1. **分布式架构**：Apache Doris采用分布式的架构设计，可以将数据分散存储在多个节点上，实现数据的并行处理和分析。这种架构使得Doris能够处理PB级别的数据量，并支持高并发的查询需求。
2. **列式存储**：Doris使用列式存储方式，将一列数据存储在一起。这种存储方式提高了查询性能和压缩比率，因为查询时只需扫描相关列，而无需扫描整个行。
3. **实时写入与查询**：Doris支持实时写入新数据，并将其与既有数据进行合并，保证数据的最新性。同时，它也支持实时查询，能够在秒级内返回海量数据下的查询结果。
4. **高性能查询**：通过多维度的索引和查询优化技术，Doris实现了高效的查询性能。其向量化执行引擎和MPP执行框架使得综合查询性能比其他产品快10~100倍。
5. **易用性**：Doris提供了丰富的SQL支持，用户可以使用熟悉的SQL语言进行数据分析。同时，它还提供了图形化界面和交互式操作，降低了学习成本。
6. **高可用与容错性**：Doris具有高可用性和容错性，通过多副本存储、节点故障自动恢复等技术手段，确保数据的安全性和系统的稳定性。

## 架构概览

其核心架构主要包括三个主要组成部分：FE (Frontend)、BE (Backend) 和 Broker。下面将详细解释这些组件及其工作原理：

### 核心组件

#### 1. Frontend (FE)

FE 是 Doris 集群的大脑，主要负责以下任务：

- **元数据管理**：维护表结构、分区信息、索引等元数据。
- **SQL 解析与优化**：接收客户端发送的 SQL 查询请求，解析并生成执行计划。
- **查询调度**：根据执行计划分配查询任务给 BE 节点，协调各节点之间的通信。
- **事务管理**：处理事务相关的逻辑，确保数据的一致性和完整性。
- **集群管理**：监控集群状态，管理 FE 和 BE 节点的加入和退出。

FE 可以部署多个实例以实现高可用性，其中一个为主节点（Leader），其他为跟随节点（Follower）。主节点负责所有的读写操作，而跟随节点则定期同步主节点的状态，以便在主节点故障时能够迅速接管。

#### 2. Backend (BE)

BE 是 Doris 的数据存储和计算单元，承担着数据的实际存储和查询执行任务：

- **数据存储**：使用列式存储格式来提高查询效率，支持多种数据压缩算法以节省存储空间。
- **查询执行**：根据 FE 分配的任务执行数据扫描、过滤、聚合等操作。
- **数据导入**：支持多种方式的数据导入，包括批量加载和流式摄入。
- **缓存机制**：通过缓存频繁访问的数据来加速查询过程。

BE 节点可以水平扩展，随着数据量的增长或查询负载的增加，可以通过添加更多的 BE 节点来提升性能。

#### 3. Broker

Broker 是一个可选组件，主要用于处理外部数据源的导入导出操作。它作为一个独立的服务运行，可以连接到 HDFS、S3 等外部存储系统，实现数据的高效传输。Broker 的主要职责包括：

- **数据导入**：从外部存储系统中读取数据并导入到 Doris 中。
- **数据导出**：将 Doris 中的数据导出到外部存储系统。

### 其他重要概念

- **Tablet**：数据的基本单位，每个 Tablet 存储在一个或多个 BE 节点上。为了保证高可用性，每个 Tablet 会有多个副本分布在不同的 BE 节点上。
- **Partition**：用于将大表划分为更小的、更易于管理的部分，每个 Partition 可以包含一个或多个 Tablet。
- **Replication**：通过多副本机制保证数据的可靠性和高可用性，通常配置为三副本。

### 工作流程

1. **查询请求**：客户端通过 JDBC 或其他接口向 FE 发送 SQL 查询请求。
2. **查询解析与优化**：FE 解析 SQL 语句，生成执行计划，并优化查询性能。
3. **任务分配**：FE 将执行计划分解为多个子任务，并分配给相应的 BE 节点。
4. **数据处理**：BE 节点根据分配的任务执行数据扫描、过滤、聚合等操作。
5. **结果合并**：FE 收集各个 BE 节点的查询结果，并进行最终的合并和排序。
6. **返回结果**：将最终的查询结果返回给客户端。

## 应用场景

- **数据仓库**
  
  作为数据仓库的核心组件，Doris 可以存储和分析企业的各种结构化数据，如销售数据、财务数据、库存数据等。通过 ETL（抽取、转换、加载）工具将不同来源的数据导入 Doris，然后利用其强大的分析功能进行数据挖掘、报表生成和决策支持。
- **用户行为分析**
  
  可以处理海量的用户行为数据，如网站浏览记录、APP 使用记录等。通过对这些数据的分析，企业可以了解用户的偏好、行为模式，进行精准营销、产品优化等操作。例如，电商企业可以分析用户的购买行为，为用户推荐个性化的商品。
- **日志分析**
  
  能够高效地处理各种系统日志和应用日志。在互联网公司中，通过对服务器日志的分析，可以及时发现系统故障、性能瓶颈等问题，保障系统的稳定运行。同时，也可以通过日志分析来统计用户访问量、资源使用情况等信息。

## 优势与对比

1. **与ClickHouse的对比**：
   
   - Doris依赖FE节点管理元数据，可用性高，不依赖外部组件；而ClickHouse依赖ZooKeeper管理元数据，容易出现数据不同步的情况。
   - Doris按照“Bucket+副本”来分布数据，灵活度更高；而ClickHouse只支持全节点分布数据或者每个节点分布一份数据。
   - Doris支持更多的Join场景需求，如Shuffle Join和Bucket Shuffle Join；而ClickHouse仅完整支持Broadcast Join、Colocate Join。
   - Doris语法完全兼容MySQL，对大小写不敏感；而ClickHouse的函数、字段类型、字段名严格区分大小写。

2. **与Snowflake的对比**：
   
   - 在弹性伸缩方面，Snowflake可以根据需求自动调整计算资源，而Doris则通过水平扩展来满足需求。
   - 在性能优化方面，两者都采用了先进的列式存储和矢量计算技术。
   - 在简化管理方面，Snowflake作为完全托管的服务，大大简化了数据仓库的管理和维护工作；而Doris则通过高度自治化的集群管理和故障自恢复功能降低了运维成本。
   - 在安全与合规方面，Snowflake提供了多层次的安全措施；而Doris作为开源数据库，其安全性依赖于用户的配置和管理。
   - 在成本效益方面，Doris采用开源模式，企业在使用时可以节省一定的成本。


