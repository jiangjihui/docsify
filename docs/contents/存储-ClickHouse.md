# ClickHouse

## 简介

ClickHouse是Yandex于2016年开源的一个用于联机分析处理（OLAP）的列式数据库管理系统（DBMS）。

ClickHouse 最初由俄罗斯公司 Yandex 开发，用于其搜索引擎的日志处理需求。现在它已经成为了一个独立的项目，被广泛应用于需要快速分析大量数据的场景中，比如互联网公司的用户行为分析、电信行业的网络性能监控、金融领域的交易数据分析等。

## 特点

1. **高性能**：ClickHouse 能够在标准硬件上实现每秒数百万行的数据插入和查询速度。它专为高速查询设计，支持实时数据分析。

2. **列式存储**：与传统的行式存储不同，ClickHouse 使用列式存储技术，这使得对大数据集进行聚合操作更加高效。

3. **SQL 支持**：ClickHouse 提供了 SQL 查询语言的支持，虽然它不是完全兼容 SQL 标准，但是它支持大多数常用的 SQL 操作，如 SELECT, JOIN, GROUP BY 等等。

4. **分布式处理**：ClickHouse 支持数据在多个节点之间的分布存储，并能够执行跨节点的分布式查询，不需要额外的 MapReduce 或其他工具来管理集群。

5. **多版本控制**：ClickHouse 支持多版本控制机制，可以有效地管理数据版本并提供一致性读取。

6. **内置复制**：为了提高可用性和可靠性，ClickHouse 内置了数据复制功能，可以设置副本数量以保证数据的安全性。

7. **可扩展性**：ClickHouse 可以水平扩展，通过增加更多的节点来提高系统的吞吐量。

8. **低延迟**：ClickHouse 在设计上考虑到了低延迟的需求，可以在毫秒级别内返回查询结果。

9. **支持多种数据格式**：ClickHouse 支持多种数据导入导出格式，包括 CSV, JSON, Parquet 等等，方便与其他系统集成。

10. **易于部署和维护**：ClickHouse 设计得易于安装和管理，可以通过简单的命令行界面进行操作。



## 局限性

1. **事务支持有限**
   - ClickHouse 主要侧重于分析型查询，对事务的支持相对较弱。它不适合用于需要高度事务一致性的场景，如在线交易处理（OLTP）。例如，在处理银行转账等事务时，ClickHouse 不能像传统的关系型数据库（如 MySQL 的 InnoDB 引擎）那样提供严格的事务保证。
2. **数据更新操作相对复杂**
   - 虽然 ClickHouse 支持数据的插入、更新和删除操作，但这些操作在大规模数据和高并发场景下相对复杂且性能可能受到影响。因为它的设计初衷是为了高效的查询处理，对于频繁的数据更新操作不是其强项。
3. **单条数据插入性能低**
   - 尽管 ClickHouse 优化了批量插入数据的场景，但单条数据插入也得到了一定的支持。在 ClickHouse 中，单条数据的插入通常不如批量插入高效，因为每次插入都需要创建一个新的数据部分（part）。对于ClickHouse而言，最佳实践通常是尽量避免单条数据插入，而是采用批量的方式进行数据加载。

## 核心概念

1. **数据分片**：
   
   - 将数据进行横向切分，查询时，多个分片同时并行查询。是解决存储和查询瓶颈的有效手段。
   - ClickHouse支持分片，分片依赖集群，每个集群由1到多个分片组成，每个分片对应一个服务节点。

2. **本地表与分布式表**：
   
   - 一张本地表等同于一份数据的分片。
     - 分布式表本身不存储任何数据，是本地表的访问代理，能够代理访问多个数据分片，实现分布式查询。

## 表引擎

**一、合并树系列（MergeTree）**

1. **MergeTree**
   
   这是 ClickHouse 中最基础且功能强大的表引擎。它支持数据分区、主键索引、数据副本等特性。数据按列存储，并支持高效的数据压缩。例如，在处理大规模数据时，能够根据设定的分区键（如按日期分区）将数据分散存储在不同的分区中，在查询时可以只扫描相关分区，大大提高查询效率。
   
   - 数据存储与索引：主键索引用于加速数据的查询定位。它会按照主键的顺序存储数据，在查询时可以快速定位到满足条件的数据范围。同时，数据以列存的方式存储在磁盘上，每个列的数据都有自己的存储文件，并且采用了有效的数据压缩算法，节省磁盘空间。

2. **ReplacingMergeTree**
   
   - 用途：主要用于去重操作。当有重复数据插入时，它会根据指定的版本列（通常是一个时间戳或者类似的标识列）来判断保留最新的数据，在后台定期合并数据块时删除重复记录。例如，在处理日志数据时，如果存在部分重复的日志记录，使用 ReplacingMergeTree 可以保证最终存储的数据是去重后的。

3. **SummingMergeTree**
   
   - 功能：适用于对数据进行聚合操作的场景。它会按照预先定义的条件（如按特定列分组）对数据进行求和聚合。在数据插入时，数据会先按规则存储，然后在后台合并操作时进行聚合计算。例如，在处理销售数据时，如果要按天对销售额进行汇总，SummingMergeTree 可以自动完成这种聚合操作，减少查询时的计算量。

**二、日志系列（Log）**

1. **TinyLog**
   - 特性：这是一种简单的表引擎，适合存储小量的、临时的数据。它没有复杂的索引结构，数据以纯文本的形式存储。由于没有索引，查询时需要全表扫描，所以只适用于数据量较小且查询频率不高的场景。例如，在测试或者临时数据存储场景下，可以使用 TinyLog 表引擎。
2. **StripeLog**
   - 特点与用途：比 TinyLog 稍微复杂一些，它将数据分成多个数据条带（stripe）存储，每个条带包含一定数量的数据行。虽然它有一定的数据结构优化，但仍然没有像 MergeTree 系列那样的高效索引。适用于存储一些不需要复杂查询的中等规模数据。

**三、内存系列（Memory）**

1. **Memory**
   - 性能与限制：数据存储在内存中，这使得查询操作非常快，因为没有磁盘 I/O 的延迟。但是，由于数据存储在内存中，受到服务器内存容量的限制，适合存储临时的、较小规模的数据，并且在服务器重启后数据会丢失。例如，在一些实时分析场景中，需要快速处理一小部分数据并展示结果，可以将数据存储在 Memory 表引擎的表中。

**四、外部存储系列**

1. **MySQL**
   - 集成功能：ClickHouse 可以通过 MySQL 表引擎与 MySQL 数据库进行集成。它可以直接查询 MySQL 数据库中的数据，就像查询本地的 ClickHouse 表一样。这对于在 ClickHouse 中整合现有的 MySQL 数据资源非常有用，例如，企业中已经有大量的 MySQL 数据库存储的数据，通过 MySQL 表引擎可以方便地在 ClickHouse 中进行分析操作。
2. **HDFS**
   - 数据交互：支持与 HDFS（Hadoop 分布式文件系统）交互。可以从 HDFS 中读取数据并进行分析，也可以将 ClickHouse 的数据导出到 HDFS 中。这使得 ClickHouse 能够与 Hadoop 生态系统进行集成，在大数据处理场景下，利用 HDFS 的大规模数据存储能力和 ClickHouse 的高效分析能力。
