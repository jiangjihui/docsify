# TCP

> 著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/develop/protocol/dev-protocol-tcpip.html

## 三次握手

### 关键步骤

TCP 的三次握手是建立可靠连接的关键步骤，其过程如下：

**一、第一次握手**

1. 客户端向服务器发送一个 SYN（Synchronize Sequence Numbers，同步序列号）报文段。
   - 这个报文段中包含客户端随机生成的初始序列号（Sequence Number，记为 client_isn）。
   - SYN 标志位被设置为 1，表示这是一个连接请求。

**二、第二次握手**

1. 服务器接收到客户端的 SYN 报文段后，向客户端发送一个 SYN/ACK 报文段作为回应。
   - 该报文段中包含服务器随机生成的初始序列号（记为 server_isn）。
   - SYN 标志位被设置为 1，表示这也是一个连接请求的回应。
   - ACK 标志位被设置为 1，表示对客户端 SYN 报文段的确认。
   - 确认号（Acknowledgment Number）被设置为 client_isn + 1，表明服务器已经收到了客户端的序列号为 client_isn 的报文段，期望下一个收到的序列号是 client_isn + 1。

**三、第三次握手**

1. 客户端接收到服务器的 SYN/ACK 报文段后，向服务器发送一个 ACK 报文段。
   - ACK 标志位被设置为 1，表示对服务器 SYN/ACK 报文段的确认。
   - 确认号被设置为 server_isn + 1，表明客户端已经收到了服务器的序列号为 server_isn 的报文段，期望下一个收到的序列号是 server_isn + 1。

### 三次握手的作用和意义

1. **建立连接**
   - 确保客户端和服务器之间能够建立起可靠的双向通信连接。通过交换序列号和确认号，双方可以确定对方的初始状态，并为后续的数据传输做好准备。
2. **同步序列号**
   - 双方通过三次握手过程来协商初始序列号，这个序列号将用于标识后续传输的数据报文段。确保数据报文段的顺序性和可靠性。
3. **防止过期连接请求**
   - 第三次握手可以防止由于网络延迟等原因导致的过期连接请求被服务器误认为是新的连接请求。如果没有第三次握手，服务器可能会在收到一个过期的 SYN 报文段后建立一个不必要的连接，浪费系统资源。
4. **检测网络状态**
   - 三次握手过程中，双方可以通过报文段的往返时间来估计网络的延迟和带宽等状态信息。这些信息可以用于调整后续的数据传输速率，提高网络性能。





## 滑动窗口

滑动窗口（Sliding Window）是 TCP 中用于流量控制的一种方法。它的主要目的是防止发送方发送过多的数据导致接收方无法处理。滑动窗口机制允许接收端告知发送端它可以接收多少数据而不至于超出缓冲区的容量。它允许发送方在不需要等待每个数据段确认的情况下，持续发送多个数据段，从而提高了传输效率。

#### 概念

滑动窗口是一个可变大小的缓冲区，它定义了发送方可以发送而不需要等待确认的数据量范围。接收方会在 ACK 包中告知发送方当前的窗口大小。

#### 工作原理

1. **发送窗口**：发送方维护一个发送窗口，用于控制可以发送但尚未收到确认的数据量。发送窗口的大小由接收方通告的接收窗口大小（rwnd）和拥塞窗口大小（cwnd）共同决定，取两者中的较小值。

2. **接收窗口**：接收方维护一个接收窗口，用于控制可以接收但尚未处理的数据量。接收窗口的大小根据接收方的处理能力和缓冲区空间动态调整。

3. **窗口滑动**：当发送方收到接收方的确认应答（ACK）时，发送窗口会向前滑动，以包含新的可发送数据。同时，接收窗口也会根据接收到的数据和自身处理能力进行调整。

#### 作用和意义

- **提高传输效率**：允许发送方在等待确认的过程中连续发送多个数据包，而不必每发送一个数据包就等待接收方的确认，从而大大提高了数据传输的效率。
- **实现流量控制**：接收方可以通过动态调整接收窗口的大小，来控制发送方的数据发送速率，避免接收方的缓冲区溢出。



## 拥塞控制

拥塞控制（Congestion Control）是指网络中的节点采取措施避免或减轻网络拥塞的过程。当网络中的数据包太多以至于超过网络的承载能力时，就会发生拥塞。拥塞会导致数据包丢失，进而影响传输效率。

**拥塞控制的主要算法**：

1. **慢开始（Slow Start）**：在连接建立或超时后，TCP使用慢开始算法逐渐增加拥塞窗口大小。初始时，拥塞窗口设置为一个较小的值（如1个MSS），每收到一个确认应答（ACK），拥塞窗口大小就加倍。这样可以快速找到网络的带宽上限，但避免了一开始就发送过多数据导致拥塞。

2. **拥塞避免（Congestion Avoidance）**：当拥塞窗口大小达到慢开始阈值（ssthresh）时，TCP进入拥塞避免阶段。在这个阶段，拥塞窗口不再以指数增长，而是每个往返时延（RTT）只增加一个MSS大小，以避免网络突然进入拥塞状态。

3. **快重传（Fast Retransmit）**：当发送方连续收到三个相同的确认应答（ACK）时，说明某个数据段在传输过程中丢失。此时，发送方会立即重传丢失的数据段，而不必等到超时。这种机制称为快重传，可以迅速纠正数据丢失，提高传输效率。

4. **快恢复（Fast Recovery）**：在执行快重传后，TCP不会立即进入慢开始阶段，而是进入快恢复阶段。在这个阶段，TCP将慢开始阈值设为当前拥塞窗口的一半，并将拥塞窗口大小设为慢开始阈值。随后，拥塞窗口每收到一个确认应答（ACK）增加一个MSS大小，直到所有丢失的数据被确认。


