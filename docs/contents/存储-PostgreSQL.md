# PostgreSQL

## 历史

PostgreSQL（简称PG）是一个功能强大的开源对象关系数据库管理系统（ORDBMS），其历史可以追溯到1970年代后期至1980年代初期的INGRES项目，该项目由Michael Stonebraker和Eugene Wong等人发起，起源于IBM System R的一系列文档。以下是PostgreSQL的详细发展历程：

#### 一 早期发展（1980年代）

- **POSTGRES项目启动**：1986年，由加州大学伯克利分校的Michael Stonebraker教授领导，POSTGRES项目开始实施。该项目旨在克服当时关系数据库系统的限制，特别是在复杂数据结构支持和扩展性方面。POSTGRES项目得到了国防高级研究计划局（DARPA）、陆军研究办公室（ARO）、美国国家科学基金会（NSF）和ESL, Inc.的赞助。
- **早期版本发布**：POSTGRES经历了多个版本的迭代，包括1987年的第一个“演示软件”系统，以及1989年至1993年期间的多个版本，这些版本主要关注可移植性和可靠性。

#### 二 Postgres95与开源之路

- **Postgres95发布**：1994年，伯克利大学的学生Andrew Yu和Jolly Chen在POSTGRES中添加了一个SQL语言解释器，并将其重命名为Postgres95。Postgres95是原始POSTGRES Berkeley代码的开源后代，它完全是ANSI C代码，性能得到了显著提升。
- **开源版本发布**：1996年，Postgres95更名为PostgreSQL，并发布了第一个开源版本。这一名称的选择旨在反映原始POSTGRES与具有SQL功能的最新版本之间的关系。同时，版本编号从6.0开始，以延续Berkeley POSTGRES项目的序列。

#### 三 持续发展与功能增强

- **版本迭代**：自1996年以来，PostgreSQL经历了多个版本的发布，每个版本都引入了新的功能和改进。例如，2000年引入了外键约束、PL/pgSQL（过程化语言）和复杂查询等功能；2005年改进了性能和可用性，引入了模板数据库、窗口函数、共享行级锁和表空间等功能。
  - 从 PostgreSQL 7.0 版本开始，它进行了重大的架构调整，增强了对事务处理和并发控制的能力。这使得它在企业级应用场景中的可靠性得到了很大提升。例如，在高并发的电商交易系统中，能够更好地处理多个用户同时进行订单提交、支付等操作。
  - PostgreSQL 8.0 引入了窗口函数，这对于数据分析和复杂报表生成等任务提供了强大的支持。通过窗口函数，可以在不使用复杂子查询的情况下，对查询结果进行分组内的排序、聚合等操作。
  - 近年来，PostgreSQL 一直保持活跃的开发状态，不断添加新的功能，如对 JSON 和 JSONB 数据类型的支持，使其能够更好地适应现代数据处理的需求，包括在物联网（IoT）和大数据应用中处理半结构化数据。它在全球范围内的应用越来越广泛，在数据库市场中占据了重要的地位。
- **功能丰富**：随着时间的推移，PostgreSQL逐渐拥有了一系列高级功能，如高级事务性、复杂查询计划、可靠的MVCC（多版本并发控制）、GIS地理信息存储等。这些特性使得PostgreSQL在企业级应用中愈发受欢迎。

## 简介

Pg 不仅仅是 SQL 数据库它可以存储 array 和 json, 可以在 array 和 json 上建索引, 甚至还能用表达式索引. 为了实现文档数据库的功能, 设计了 jsonb 的存储结构. 有人会说为什么不用 Mongodb 的 BSON 呢? Pg 的开发团队曾经考虑过, 但是他们看到 BSON 把 ["a", "b", "c"] 存成 {0: "a", 1: "b", 2: "c"} 的时候就决定要重新做一个 jsonb 了... 现在 jsonb 的性能已经优于 BSON.

MySQL 的各种 text 字段有不同的限制, 要手动区分 small text, middle text, large text... Pg 没有这个限制, text 能支持各种大小.

它自带全文搜索功能 (不用费劲再装一个 elasticsearch 咯)。

它有地理信息处理扩展 (GIS 扩展不仅限于真实世界, 游戏里的地形什么的也可以), 可以用 Pg 搭寻路服务器和地图服务器。PG 多年来在 GIS 领域处于优势地位，因为它有丰富的几何类型，实际上不止几何类型，PG有大量字典、数组、bitmap 等数据类型，相比之下mysql就差很多，instagram就是因为PG的空间数据库扩展POSTGIS远远强于MYSQL的my spatial而采用PGSQL的。

它可以把 70 种外部数据源 (包括 Mysql, Oracle, CSV, hadoop ...) 当成自己数据库中的表来查询。

## PostgreSQL 与MySQL的区别

1. **开源许可**：
   
   - PostgreSQL 是一个开源数据库系统，使用的是类似于 **BSD** 的许可协议。可以进行二开变成自己的商业版本。
   - MySQL 同样是开源的，但是使用的是 GNU General Public License (**GPL**) 许可证。虽然 MySQL 提供了商业许可证选项，但其核心版本仍然是免费且开放源代码的。

2. **数据类型支持**：
   
   - PostgreSQL 支持复杂的数据类型，如 JSON、XML 和地理空间数据，并且提供了丰富的函数来处理这些数据类型。
   - MySQL 也支持多种数据类型，但在默认情况下对 JSON 和地理空间的支持不如 PostgreSQL 强大。

3. **事务与并发控制**：
   
   - PostgreSQL：原生支持MVCC（多版本并发控制），并且对于事务隔离、并发控制有更强大的功能，包括表锁、行锁、死锁检测等功能，使其更适合高并发场景。
   - MySQL：使用MVCC机制，但仅在InnoDB引擎中支持。事务的支持相对简单，对于复杂并发操作的处理稍显薄弱。

4. **SQL 标准兼容性**：
   
   - PostgreSQL 致力于 SQL 标准的兼容性，并实现了许多 SQL:2008 标准的功能。
   - MySQL 则在一定程度上遵循 SQL 标准，但也有自己独特的语法和功能。

5. **性能和优化**：
   
   - MySQL 通常被认为在**读取密集型**负载下表现良好，并且提供了多种优化工具，如索引、缓存等。
     在读操作和简单查询场景中性能通常较高，特别是在Web应用中使用较多。在不需要复杂事务和数据完整性检查的情况下，MySQL常常是性能优选。
   
   - PostgreSQL 在**写入密集型**负载和**复杂的查询**上表现得更好，尤其是在需要执行复杂 SQL 查询的应用场景中。
     在复杂查询和数据分析场景中，PostgreSQL的性能通常表现优越。其优化器在处理复杂JOIN、子查询等场景时表现更好。

6. **安全性**：
   
   - PostgreSQL 和 MySQL 都有良好的安全记录，但 PostgreSQL 在某些方面可能提供更细粒度的安全控制。
   - MySQL 也有强大的安全功能，特别是在 MySQL 企业版中。

7. **复制与高可用性**：
   
   - PostgreSQL：提供流复制和逻辑复制，支持异步和同步复制，并且一致性较好。社区还提供了成熟的分片解决方案（如Citus）。
   - MySQL：支持多种复制方式，包括主从复制和组复制等。但其在一致性方面可能稍逊于PostgreSQL，主从复制的延迟是常见问题。不过，MySQL也通过MySQL Group Replication、Galera Cluster等工具实现了高可用性和负载均衡。

8. **应用场景**：
   
   - PostgreSQL：更适合需要复杂查询、数据一致性、高度扩展性和高级SQL功能的场景，如金融系统、科学计算、大数据分析等。
   - MySQL：更适合需要快速读写操作、较简单的查询和广泛的社区支持的场景，如Web应用、内容管理系统、电子商务网站等。

## 相关概念

### GIN和BTREE索引（JSONB数据类型）

PostgreSQL对JSONB数据类型的GIN和BTREE索引提供了高效的方式来查询和优化半结构化数据。以下是关于这两种索引的详细解释：

#### 一 GIN索引

1. **概述**：
   
   - GIN（Generalized Inverted Index，通用倒排索引）是一个存储对（key, posting list）集合的索引结构。
   - 其中，“key”是一个键值，而“posting list”是一组出现过“key”的位置。

2. **特点**：
   
   - 适用于索引JSONB字段中的任何值，支持范围查询和部分匹配查询。
   - 提供了丰富的查询操作，如路径表达式和聚合函数。
   - 可扩展性强，允许自定义数据类型和访问方法。

3. **使用场景**：
   
   - 当需要搜索JSONB字段中的多个键或值时，GIN索引可以显著提高查询性能。
   - 适用于物联网（IoT）和大数据应用中，需要对半结构化数据进行复杂查询的场景。

4. **创建示例**：
   
   ```sql
   CREATE INDEX idx_users_data_name ON users USING GIN (data->>'name');
   ```
   
   上述代码创建了一个GIN索引，用于索引`users`表中`data`字段的`name`键。注意，这里使用了`->>`运算符来提取JSON字段中的值。
   如果需要支持搜索任意属性，可以使用以下方式创建GIN索引：
   
   ```sql
   CREATE INDEX idx_users_data_all ON users USING GIN (data jsonb_ops);
   ```
   
   或者使用`jsonb_path_ops`操作符创建，但请注意，它只支持索引`@>`操作符：
   
   ```sql
   CREATE INDEX idx_users_data_path ON users USING GIN (data jsonb_path_ops);
   ```

#### 二 BTREE索引

1. **概述**：
   
   - BTREE（B-Tree）是一种平衡树索引结构，每个节点包含多个键值对和指向子节点的指针。
   - 在PostgreSQL中，BTREE是默认的索引类型，适用于大多数查询场景。

2. **特点**：
   
   - 适用于对JSONB字段中的特定键进行等值查询和范围查询。
   - 索引结构相对简单，查询效率较高。
   - 但对于JSONB这种半结构化数据，BTREE索引可能不如GIN索引灵活。

3. **使用场景**：
   
   - 当需要对JSONB字段中的某个特定键进行频繁查询时，BTREE索引可以提供一个有效的解决方案。
   - 适用于需要对半结构化数据进行简单查询和排序的场景。

4. **创建示例**：
   
   ```sql
   CREATE INDEX idx_users_data_value ON users USING BTREE ((data->>'value'));
   ```
   
   上述代码创建了一个BTREE索引，用于索引`users`表中`data`字段的`value`键的值。同样地，这里使用了`->>`运算符来提取JSON字段中的值。

#### 三 比较与选择

- **灵活性**：GIN索引更灵活，支持对JSONB字段中的任意键和值进行索引和查询。而BTREE索引通常只能对特定键进行索引。
- **查询性能**：对于复杂的查询和范围查询，GIN索引通常比BTREE索引性能更优。但对于简单的等值查询，BTREE索引可能具有更好的性能。
- **存储开销**：GIN索引的存储开销可能比BTREE索引大，因为它需要存储更多的元数据和指针信息。

因此，在选择索引类型时，需要根据具体的查询需求和性能要求进行权衡。对于物联网（IoT）和大数据应用中的半结构化数据查询，GIN索引通常是一个更好的选择。但对于简单的等值查询和排序操作，BTREE索引可能更为合适。

### GIN索引

GIN索引是PostgreSQL中一种用于处理包含数组、JSON和全文搜索等复杂数据类型的索引结构。它基于倒排索引（Inverted Index）的概念构建。倒排索引主要用于加速对包含大量文本或者复杂数据结构中的元素查找。例如，在一个文档数据库中，倒排索引可以帮助快速找到包含某个特定词汇的所有文档。

#### 数据结构

- **倒排表（Posting List）**
- GIN索引的核心是倒排表。对于索引的每个键值（例如，在JSON数据中，每个键或者在数组中的每个元素都可以是一个键值），GIN索引维护一个倒排表。倒排表记录了包含该键值的所有行标识符（通常是行的物理存储位置或者主键值）。例如，假设有一个包含文章内容的表，其中有一个列是标签数组（如`['technology', 'startup', 'innovation']`），对于标签`technology`，其倒排表会记录所有包含`technology`标签的文章的行标识符。
- **索引项（Index Entries）**
- 索引项是GIN索引中存储数据的基本单位。每个索引项对应一个键值，并且包含指向倒排表的指针。在构建索引时，PostgreSQL会遍历要索引的数据列，提取键值并创建索引项和相应的倒排表。例如，在索引一个JSONB列时，对于JSONB对象中的每个键 - 值对，会创建一个索引项，如果值是一个数组，还会为数组中的每个元素创建索引项。

#### 索引构建过程

- 当在一个表列上创建GIN索引时，PostgreSQL会按照以下步骤进行索引构建：

- **数据扫描**：首先，数据库会扫描要索引的列。对于每一行的数据，根据数据类型提取出需要索引的元素。例如，在索引一个数组类型的列时，会提取数组中的每个元素；在索引JSONB数据时，会提取对象中的键和值，以及数组元素等。

- **索引项创建**：针对提取出的每个元素，创建一个索引项。如果是新出现的元素，会分配新的索引项空间，并记录该元素对应的倒排表位置。如果元素已经存在索引项，则直接获取其对应的索引项。

- **倒排表更新**：对于每个索引项，将当前行的标识符添加到其对应的倒排表中。这样，当查询包含某个元素的行时，可以通过索引项快速找到倒排表，进而获取所有包含该元素的行标识符。

- 例如，假设有一个名为`products`的表，其中有一个`tags`列是`text[]`类型（文本数组），内容如下：
  
  | product_id | tags                               |
  | ---------- | ---------------------------------- |
  | 1          | {'electronics', 'gadgets'}         |
  | 2          | {'electronics', 'home appliances'} |
  | 3          | {'home appliances', 'furniture'}   |

- 当在`tags`列上创建GIN索引时，对于标签`electronics`，其倒排表会记录行标识符`1`和`2`；对于`gadgets`，倒排表记录`1`；对于`home appliances`，倒排表记录`2`和`3`，以此类推。

#### 查询处理

- 当执行一个涉及GIN索引的查询时，例如在一个带有JSONB列的表中查询包含某个特定键值的行，PostgreSQL会执行以下操作：
- **索引查找**：首先，在GIN索引中查找与查询条件对应的索引项。如果查询条件是一个数组元素或者JSON键值，数据库会定位到该元素或键值对应的索引项。
- **获取倒排表**：通过索引项找到对应的倒排表，倒排表中包含了满足查询条件的所有行标识符。
- **行检索**：使用倒排表中的行标识符，从表中检索出实际的行数据。这样就完成了基于GIN索引的查询操作，大大提高了查询效率，尤其是在处理包含大量复杂数据（如数组、JSON）的表时。
- 例如，在上述`products`表中，如果要查询包含`electronics`标签的产品，数据库会先在GIN索引中找到`electronics`对应的索引项和倒排表，从倒排表中获取行标识符`1`和`2`，然后从`products`表中检索出`product_id`为`1`和`2`的行数据。

## 基本操作

**登陆PostgreSQL控制台**

```
# psql
或
# psql -U postgres
```

**设置用户密码**

```
> \password postgres
```

> 备注：设置psotgres用户密码

**创建数据库用户**

```java
> CREATE USER dbuser WITH PASSWORD 'password';
```

**创建数据库**

```
> CREATE DATABASE exampledb OWNER dbuser;
```

**角色赋权**

```
> GRANT ALL PRIVILEGES ON DATABASE exampledb to dbuser;
```

**退出控制台**

```
> \q
```

> 备注：也可以直接按ctrl+D

## 命令

- \h：查看SQL命令的解释，比如\h select。
- \?：查看psql命令列表。
- \l：列出所有数据库。
- \c [database_name]：连接其他数据库。
- \d：列出当前数据库的所有表格。
- \d [table_name]：列出某一张表格的结构。
- \du：列出所有用户。
- \e：打开文本编辑器。
- \conninfo：列出当前数据库和连接的信息。
