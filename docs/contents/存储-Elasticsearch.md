## 简介

Elasticsearch是一个实时的分布式搜索和分析引擎。它可以帮助你用前所未有的速度去处理大规模数据。使用**Lucene**作为内部引擎，但是在使用它做全文搜索时，只需要使用统一开发好的API即可，而不需要了解其背后复杂的Lucene的运行原理。

Elasticsearch 是基于 RESTful 接口的搜索与分析引擎。它能够解决几乎任何类型的搜索问题，并且可以扩展到上百台服务器及 PB 级别结构化或非结构化数据。Elasticsearch 是 Elastic Stack（也称为 ELK Stack）的核心组件之一，其他组件包括 Kibana（用于数据可视化）、Logstash（用于数据收集、增强、以及处理），以及 Beats（一组轻量级的数据发送器）。

### 历史背景

Elasticsearch 由 Shay Banon 在 2010 年创建，并于 2012 年正式发布。它基于 Apache Lucene 搜索库，使用 Java 编写，支持多种编程语言的客户端。

### 特性

- **分布式架构**：Elasticsearch 可以水平扩展，通过添加更多节点来增加其处理能力和存储容量。
- **实时分析**：Elasticsearch 支持近实时的文档索引和检索。
- **RESTful API**：使用 HTTP 协议和 JSON 数据格式进行交互，易于集成到现有的技术栈中。
- **多租户能力**：可以为不同的用户或应用程序提供独立的服务实例。
- **插件化**：支持插件来扩展其功能，例如特定领域的分析器。
- **丰富的查询 DSL**：提供了强大的查询语言来执行复杂的搜索操作。
- **集群健康监控**：内置了监控工具来帮助管理员了解集群的状态。
- **高可用性**：通过复制和分片机制来保证数据的可靠性和系统的可用性。
- **自动恢复**：当节点发生故障时，可以自动重新分配索引数据。

### 应用场景

Elasticsearch 被广泛应用于各种场景中，包括但不限于：

- **日志分析**：通过收集、分析系统和应用的日志信息，帮助监控系统的健康状态。
- **全文搜索**：实现网站或应用中的搜索功能，支持模糊匹配、前缀搜索等多种搜索方式。
- **数据分析**：可以用来进行复杂的聚合分析，例如用户行为分析、趋势分析等。
- **实时监控**：结合 Kibana 实现实时的数据展示，对关键指标进行监控。



### 基础架构与概念

1. **分布式特性**
   
   - Elasticsearch 将数据分布在多个节点（Node）上，这些节点组成一个集群（Cluster）。集群中的每个节点都可以存储数据、处理查询请求并执行索引操作。这种分布式架构使得 Elasticsearch 能够处理海量数据，并且具有高可用性和可扩展性。
   - 集群中的节点可以分为不同的角色，例如主节点（Master Node）负责管理集群的元数据、节点的加入和离开等操作；数据节点（Data Node）负责存储和索引数据并处理查询请求。

2. **索引（Index）**
   
   - 类似于传统数据库中的数据库概念，是一个逻辑上的命名空间，用于存储具有相似特征的文档（Document）。例如，可以有一个名为 “customers” 的索引来存储所有客户相关的文档，或者一个名为 “products” 的索引来存储产品信息。
   - 每个索引有自己的设置，包括映射（Mapping）定义、分片（Shard）数量等。

3. **文档（Document）**
   
   - 是 Elasticsearch 中可被索引的基本数据单元，以 JSON 格式表示。例如，在一个 “customers” 索引中，一个客户的所有信息（如姓名、年龄、地址等）可以组成一个文档。每个文档都有一个唯一的标识符（_id），可以由 Elasticsearch 自动生成，也可以由用户自定义。

4. **映射（Mapping）**
   
   - 定义了索引中的文档结构，类似于数据库中的表结构定义。它指定了文档中的字段（Field）名称、类型（如文本、数字、日期等）以及如何对这些字段进行索引和搜索。例如，可以定义一个 “name” 字段为文本类型，并且指定它是否需要进行全文搜索、是否区分大小写等。

5. **分片（Shard）与副本（Replica）**
   
   - 分片是将索引数据水平分割成的多份，每个分片本身是一个独立的 Lucene 索引。通过将数据分布在多个分片上，可以提高索引和查询的性能，尤其是在处理大量数据时。
   - 副本是分片的拷贝，主要用于提高数据的可用性和容错性。当一个分片所在的节点出现故障时，可以从副本中获取数据。副本还可以分担查询负载，提高查询的并发处理能力。

#### 对比关系型数据库

基本概念的理解，就是要知道index, type, document, field这些名词到底啥意思，看下表：

| **Relational DB** | **Elasticsearch** | **释义**     |
| ----------------- | ----------------- | ---------- |
| Databases         | Indices           | 索引(名词)即数据库 |
| Tables            | Types             | 类型即表名      |
| Rows              | Documents         | 文档即每行数据    |
| Columns           | Fields            | 字段         |

（传统关系型数据库（如 MySQL）与 Elasticsearch 对比）

## Elasticsearch 的工作原理

### （一）数据索引过程

1. **文档分析**
   
   - 当一个文档被索引时，首先要对文档进行分析。分析过程包括将文档内容分解成单个的词项（Token），并对这些词项进行处理，如转换为小写、去除停用词（如 “the”“and” 等常见但对搜索意义不大的词）等。这一过程是根据索引的映射中定义的分析器（Analyzer）来进行的。
   - 例如，对于一个包含句子 “Elasticsearch is a great search engine” 的文档，分析器可能会将其分解为词项 “elasticsearch”“great”“search”“engine” 等。

2. **写入分片**
   
   - 经过分析后的文档数据被写入到索引的分片中。Elasticsearch 根据文档的标识符或其他路由规则来确定文档应该写入哪个分片。如果是新创建的索引，Elasticsearch 会根据索引的初始设置（如默认的分片数量）来分配分片。
   - 例如，如果一个索引有 3 个分片，文档可能根据其_id 的哈希值被路由到其中一个分片上。

3. **数据持久化**
   
   - 写入分片的数据会被持久化到磁盘上，以确保数据的安全性。Elasticsearch 使用了 Lucene 的索引文件结构来存储数据，这些文件结构包含了词项字典、倒排索引等数据结构，用于快速的搜索操作。

### （二）数据搜索过程

1. **查询解析**
   - 当用户发起一个搜索查询时，Elasticsearch 首先对查询进行解析。查询可以是简单的关键词查询，也可以是复杂的布尔查询、聚合查询等。Elasticsearch 会将查询解析成内部可以处理的形式。
   - 例如，对于一个查询 “search for products with price> 100”，Elasticsearch 会解析出这是一个对 “products” 索引中 “price” 字段的范围查询。
2. **分片查询**
   - 解析后的查询会被发送到包含相关索引分片的节点上。每个分片独立地执行查询操作，在自己的数据范围内查找匹配的文档。这是因为每个分片本身是一个独立的 Lucene 索引，具有自己的查询处理能力。
   - 例如，如果 “products” 索引有 3 个分片，查询会同时被发送到这 3 个分片上，每个分片查找自己内部符合查询条件的文档。
3. **结果合并与排序**
   - 各个分片返回的查询结果会被合并到一起。然后根据查询中指定的排序规则（如按照相关性、按照某个字段的值等）对结果进行排序。
   - 例如，如果查询要求按照相关性排序，Elasticsearch 会根据文档与查询的匹配程度对合并后的结果进行排序，然后将最终的结果返回给用户。

## IK分词器

Elasticsearch的默认分词器对英文支持较好，对中文分词不太友好，会将每个汉字单独分词。所以我们可以通过安装IK分词器来实现对中文的分词。

### 安装

进入[下载页面](https://github.com/medcl/elasticsearch-analysis-ik/tags)选择对应与当前 Elasticsearch 版本一致的版本下载之后解压到Elasticsearch程序目录下的 plugins 文件夹即可。

### 模式

IK分词器包含2种模式：

- `ik_smart`：最少切分
- `ik_max_word`：最细切分

### 词库

要扩展或者禁用某些敏感词条，只需要修改一个ik分词器目录中的config目录中的IkAnalyzer.cfg.xml文件：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
    <comment>IK Analyzer扩展配置</comment>
    <!--用户可以在这里配置自己的扩展字典-->
    <entry key="ext_dict">ext.dic</entry>

    <!--用户可以在这里配置自己的扩展停止词字典***添加停用词词典-->
    <entry key="ext_stopwords">stopword.dic</entry>
</properties>
```

备注：字典文件中以换行来区分每个词。

## 安装

[下载](https://www.elastic.co/downloads/elasticsearch)zip包解压运行其中bin/elasticsearch.bat即可

> 备注：推荐使用PostMan进行练习而不是Google插件sense


