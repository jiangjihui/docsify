# Kubernetes ï¼ˆK8sï¼‰

Kubernetesï¼ˆé€šå¸¸ç¼©å†™ä¸º K8sï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†ã€‚

## èµ·æºå’Œå‘å±•

### èµ·æº

Kubernetes çš„èµ·æºå¯ä»¥è¿½æº¯åˆ° Google å†…éƒ¨çš„ Borg ç³»ç»Ÿã€‚Borg æ˜¯ Google å¼€å‘çš„ä¸€ä¸ªå¤§è§„æ¨¡é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œç”¨äºç®¡ç† Google å†…éƒ¨çš„æ•°æ®ä¸­å¿ƒèµ„æºã€‚Borg ç³»ç»Ÿèƒ½å¤Ÿé«˜æ•ˆåœ°è°ƒåº¦å’Œç®¡ç†æˆåƒä¸Šä¸‡çš„åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ï¼Œç¡®ä¿å®ƒä»¬åœ¨é«˜è´Ÿè½½ä¸‹ç¨³å®šè¿è¡Œã€‚

- **Borg ç³»ç»Ÿçš„å½±å“**ï¼šBorg ç³»ç»Ÿåœ¨ Google å†…éƒ¨è¿è¡Œäº†å¤šå¹´ï¼Œç§¯ç´¯äº†ä¸°å¯Œçš„ç»éªŒå’ŒæŠ€æœ¯ã€‚Google çš„å·¥ç¨‹å¸ˆä»¬æ„è¯†åˆ°ï¼ŒBorg çš„æˆåŠŸç»éªŒå¯ä»¥æ¨å¹¿åˆ°æ›´å¹¿æ³›çš„ç¤¾åŒºï¼Œå¸®åŠ©å…¶ä»–å…¬å¸è§£å†³ç±»ä¼¼çš„å®¹å™¨ç¼–æ’é—®é¢˜ã€‚

- **Docker çš„å…´èµ·**ï¼š2013 å¹´ï¼ŒDocker çš„å‘å¸ƒä½¿å¾—å®¹å™¨æŠ€æœ¯å˜å¾—æ›´åŠ æµè¡Œå’Œæ˜“äºä½¿ç”¨ã€‚Docker æä¾›äº†ä¸€ç§è½»é‡çº§çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œä½¿å¾—åº”ç”¨ç¨‹åºå¯ä»¥åœ¨éš”ç¦»çš„ç¯å¢ƒä¸­è¿è¡Œï¼Œè€Œä¸éœ€è¦å®Œæ•´çš„è™šæ‹Ÿæœºã€‚Docker çš„å…´èµ·æ¨åŠ¨äº†å®¹å™¨æŠ€æœ¯çš„æ™®åŠï¼Œä½†ä¹Ÿå¸¦æ¥äº†æ–°çš„æŒ‘æˆ˜ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§è§„æ¨¡éƒ¨ç½²å’Œç®¡ç†å®¹å™¨æ—¶ã€‚

### Kubernetes çš„è¯ç”Ÿ

2014 å¹´ï¼ŒGoogle å†³å®šå°† Borg ç³»ç»Ÿçš„ç»éªŒå¼€æºï¼Œå¹¶æ¨å‡ºäº† Kubernetes é¡¹ç›®ã€‚Kubernetes çš„è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªé€šç”¨çš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œèƒ½å¤Ÿç®¡ç†å¤§è§„æ¨¡çš„å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€‚

- **å¼€æºå‘å¸ƒ**ï¼š2014 å¹´ 6 æœˆï¼ŒGoogle åœ¨ GitHub ä¸Šå¼€æºäº† Kubernetes é¡¹ç›®ã€‚Kubernetes çš„åˆå§‹ç‰ˆæœ¬åŸºäº Borg ç³»ç»Ÿçš„è®¾è®¡ç†å¿µï¼Œä½†è¿›è¡Œäº†ç®€åŒ–å’Œä¼˜åŒ–ï¼Œä»¥é€‚åº”æ›´å¹¿æ³›çš„ç”¨æˆ·éœ€æ±‚ã€‚

- **ç¤¾åŒºå‚ä¸**ï¼šKubernetes çš„å¼€æºå¸å¼•äº†å¤§é‡çš„å¼€å‘è€…å’Œå…¬å¸å‚ä¸ã€‚Google ä¸ Linux åŸºé‡‘ä¼šåˆä½œï¼Œæˆç«‹äº† Cloud Native Computing Foundationï¼ˆCNCFï¼‰ï¼Œä»¥æ¨åŠ¨ Kubernetes å’Œäº‘åŸç”ŸæŠ€æœ¯çš„å‘å±•ã€‚

### å‘å±•å†ç¨‹

è‡ª 2014 å¹´å¼€æºä»¥æ¥ï¼ŒKubernetes ç»å†äº†å¿«é€Ÿçš„å‘å±•å’Œæ¼”å˜ï¼Œé€æ¸æˆä¸ºå®¹å™¨ç¼–æ’é¢†åŸŸçš„äº‹å®æ ‡å‡†ã€‚

- **æ—©æœŸç‰ˆæœ¬**ï¼šKubernetes çš„æ—©æœŸç‰ˆæœ¬ï¼ˆ1.0 ä¹‹å‰ï¼‰ä¸»è¦å…³æ³¨æ ¸å¿ƒåŠŸèƒ½çš„å¼€å‘å’Œç¨³å®šæ€§ã€‚Google å’Œå…¶ä»–è´¡çŒ®è€…ä¸æ–­æ”¹è¿› Kubernetes çš„æ¶æ„å’ŒåŠŸèƒ½ï¼Œä½¿å…¶èƒ½å¤Ÿæ›´å¥½åœ°æ”¯æŒç”Ÿäº§ç¯å¢ƒã€‚

- **1.0 ç‰ˆæœ¬å‘å¸ƒ**ï¼š2015 å¹´ 7 æœˆï¼ŒKubernetes 1.0 ç‰ˆæœ¬æ­£å¼å‘å¸ƒï¼Œæ ‡å¿—ç€ Kubernetes å·²ç»å‡†å¤‡å¥½ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚1.0 ç‰ˆæœ¬å¼•å…¥äº†è®¸å¤šå…³é”®åŠŸèƒ½ï¼Œå¦‚ Podã€Serviceã€Replication Controller ç­‰ã€‚

- **CNCF çš„æˆç«‹**ï¼š2015 å¹´ï¼ŒGoogle ä¸ Linux åŸºé‡‘ä¼šåˆä½œæˆç«‹äº† Cloud Native Computing Foundationï¼ˆCNCFï¼‰ï¼ŒKubernetes æˆä¸º CNCF çš„ç¬¬ä¸€ä¸ªé¡¹ç›®ã€‚CNCF çš„æˆç«‹è¿›ä¸€æ­¥æ¨åŠ¨äº† Kubernetes çš„ç¤¾åŒºå‘å±•å’Œç”Ÿæ€ç³»ç»Ÿçš„å»ºè®¾ã€‚

- **ç”Ÿæ€ç³»ç»Ÿçš„æ‰©å±•**ï¼šéšç€ Kubernetes çš„æ™®åŠï¼Œè¶Šæ¥è¶Šå¤šçš„å…¬å¸å’Œå¼€å‘è€…å¼€å§‹å›´ç»• Kubernetes æ„å»ºå·¥å…·å’ŒæœåŠ¡ã€‚ä¾‹å¦‚ï¼ŒHelm æä¾›äº† Kubernetes åº”ç”¨çš„åŒ…ç®¡ç†åŠŸèƒ½ï¼ŒIstio æä¾›äº†æœåŠ¡ç½‘æ ¼çš„æ”¯æŒï¼ŒPrometheus æä¾›äº†ç›‘æ§å’Œå‘Šè­¦åŠŸèƒ½ã€‚

- **æŒç»­æ¼”è¿›**ï¼šKubernetes çš„å¼€å‘éµå¾ªä¸¥æ ¼çš„å‘å¸ƒå‘¨æœŸï¼Œæ¯ä¸‰ä¸ªæœˆå‘å¸ƒä¸€ä¸ªæ–°ç‰ˆæœ¬ã€‚æ¯ä¸ªç‰ˆæœ¬éƒ½ä¼šå¼•å…¥æ–°çš„åŠŸèƒ½å’Œæ”¹è¿›ï¼ŒåŒæ—¶ä¿æŒå‘åå…¼å®¹æ€§ã€‚Kubernetes çš„ç¤¾åŒºæ´»è·ƒåº¦éå¸¸é«˜ï¼Œè´¡çŒ®è€…æ¥è‡ªå…¨çƒå„åœ°çš„å…¬å¸å’Œç»„ç»‡ã€‚

### ç°çŠ¶ä¸æœªæ¥

æˆªè‡³ 2023 å¹´ï¼ŒKubernetes å·²ç»æˆä¸ºå®¹å™¨ç¼–æ’é¢†åŸŸçš„äº‹å®æ ‡å‡†ï¼Œè¢«å¹¿æ³›åº”ç”¨äºå„ç§è§„æ¨¡çš„ä¼ä¸šå’Œç»„ç»‡ä¸­ã€‚



## Kubernetes æ¶æ„

### èŠ‚ç‚¹ç»„ä»¶

#### Master èŠ‚ç‚¹

- **API Server**ï¼šæ˜¯ Kubernetes é›†ç¾¤çš„å‰ç«¯æ¥å£ï¼Œå®ƒæä¾›äº† HTTP/HTTPS RESTful APIï¼Œç”¨äºæ¥æ”¶ç”¨æˆ·è¯·æ±‚å¹¶è¿›è¡Œå¤„ç†ã€‚æ‰€æœ‰çš„ç®¡ç†æ“ä½œï¼Œå¦‚åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°å®¹å™¨ç­‰æ“ä½œéƒ½æ˜¯é€šè¿‡ API Server è¿›è¡Œçš„ã€‚
- **Scheduler**ï¼šè´Ÿè´£æ ¹æ®å®¹å™¨çš„èµ„æºéœ€æ±‚å’ŒèŠ‚ç‚¹çš„å¯ç”¨èµ„æºç­‰å› ç´ ï¼Œå°†å®¹å™¨è°ƒåº¦åˆ°åˆé€‚çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ä¾‹å¦‚ï¼Œå®ƒä¼šè€ƒè™‘èŠ‚ç‚¹çš„ CPUã€å†…å­˜ç­‰èµ„æºä½¿ç”¨æƒ…å†µï¼Œä»¥åŠå®¹å™¨å¯¹ç¡¬ä»¶çš„ç‰¹æ®Šè¦æ±‚ï¼ˆå¦‚ GPU ç­‰ï¼‰æ¥è¿›è¡Œè°ƒåº¦ã€‚
- **Controller Manager**ï¼šåŒ…å«äº†å¤šä¸ªæ§åˆ¶å™¨ï¼Œå¦‚ ReplicationControllerã€DeploymentController ç­‰ã€‚è¿™äº›æ§åˆ¶å™¨ç”¨äºä¿è¯é›†ç¾¤çš„çŠ¶æ€ç¬¦åˆç”¨æˆ·æœŸæœ›çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼ŒReplicationController ä¼šç¡®ä¿å®¹å™¨å‰¯æœ¬çš„æ•°é‡å§‹ç»ˆä¿æŒåœ¨ç”¨æˆ·å®šä¹‰çš„æ•°é‡ä¸Šã€‚

#### Worker èŠ‚ç‚¹ï¼ˆä¹Ÿç§°ä¸º Nodeï¼‰

- **Kubelet**ï¼šè¿è¡Œåœ¨æ¯ä¸ª Worker èŠ‚ç‚¹ä¸Šï¼Œå®ƒè´Ÿè´£ä¸ Master èŠ‚ç‚¹é€šä¿¡ï¼Œæ¥æ”¶ Master èŠ‚ç‚¹ä¸‹å‘çš„ä»»åŠ¡ï¼Œå¹¶ç®¡ç†æœ¬èŠ‚ç‚¹ä¸Šè¿è¡Œçš„å®¹å™¨ã€‚ä¾‹å¦‚ï¼Œå®ƒä¼šæŒ‰ç…§ Master èŠ‚ç‚¹çš„è¦æ±‚ï¼Œä¸‹è½½å®¹å™¨é•œåƒã€å¯åŠ¨æˆ–åœæ­¢å®¹å™¨ç­‰æ“ä½œã€‚
- **Container Runtime**ï¼šæ˜¯è´Ÿè´£å®é™…è¿è¡Œå®¹å™¨çš„è½¯ä»¶ï¼Œå¸¸è§çš„å¦‚ Dockerã€Containerd ç­‰ã€‚å®ƒæ ¹æ® Kubelet çš„æŒ‡ä»¤æ¥è¿è¡Œå®¹å™¨ï¼ŒåŒ…æ‹¬å®¹å™¨çš„åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ç­‰æ“ä½œã€‚
- **kube - proxy**ï¼šä¸»è¦è´Ÿè´£å®ç°æœåŠ¡çš„ä»£ç†å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚å®ƒä¼šåœ¨èŠ‚ç‚¹ä¸Šè®¾ç½®è§„åˆ™ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°æ­£ç¡®çš„å®¹å™¨æœåŠ¡ä¸Šã€‚



### èµ„æºå¯¹è±¡

Kubernetes èµ„æºå¯¹è±¡ ä¸»è¦åŒ…æ‹¬ podã€serviceã€deploymentã€‚

- **Pod** æ˜¯ Kubernetes ä¸­**æœ€å°çš„å¯éƒ¨ç½²å’Œå¯ç®¡ç†çš„è®¡ç®—å•å…ƒ**ï¼Œå®ƒå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç´§å¯†ç›¸å…³çš„å®¹å™¨ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåŒ…å«ä¸»åº”ç”¨ç¨‹åºå®¹å™¨å’Œè¾…åŠ©æ—¥å¿—æ”¶é›†å®¹å™¨çš„ç»„åˆå¯ä»¥æ”¾åœ¨ä¸€ä¸ª Pod ä¸­ã€‚è¿™äº›å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ã€å­˜å‚¨å·ç­‰èµ„æºï¼Œå®ƒä»¬ä¹‹é—´çš„é€šä¿¡å¯ä»¥é€šè¿‡[localhost](https://localhost/)è¿›è¡Œã€‚

- **Service** æ˜¯ä¸€ç§**æŠ½è±¡çš„èµ„æº**ï¼Œç”¨äºå®šä¹‰ä¸€ç»„ Pod çš„è®¿é—®ç­–ç•¥ã€‚å®ƒæä¾›äº†ä¸€ä¸ªç¨³å®šçš„ IP åœ°å€å’Œ DNS åç§°ï¼Œä½¿å¾—å…¶ä»– Pod æˆ–è€…å¤–éƒ¨å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è¿™ä¸ªç»Ÿä¸€çš„å…¥å£è®¿é—®åç«¯çš„ Podã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª Web æœåŠ¡å¯ä»¥é€šè¿‡ Service æ¥å¯¹å¤–æä¾›æœåŠ¡ï¼Œè€Œä¸ç®¡åç«¯çš„ Web å®¹å™¨æœ‰å¤šå°‘ä¸ªæˆ–è€…å¦‚ä½•å˜åŒ–ã€‚

- **Deployment** ç”¨äº**ç®¡ç† Pod çš„éƒ¨ç½²å’Œæ›´æ–°**ã€‚å®ƒå¯ä»¥å®šä¹‰ Pod çš„å‰¯æœ¬æ•°é‡ã€æ›´æ–°ç­–ç•¥ç­‰ã€‚ä¾‹å¦‚ï¼Œåœ¨è¿›è¡Œåº”ç”¨ç¨‹åºç‰ˆæœ¬æ›´æ–°æ—¶ï¼ŒDeployment å¯ä»¥æ§åˆ¶æ›´æ–°çš„æ–¹å¼ï¼Œå¦‚æ»šåŠ¨æ›´æ–°ï¼ˆé€æ­¥æ›¿æ¢æ—§ç‰ˆæœ¬çš„ Pod ä¸ºæ–°ç‰ˆæœ¬ï¼‰æˆ–è€…è“ç»¿æ›´æ–°ï¼ˆå…ˆå¯åŠ¨æ–°ç‰ˆæœ¬çš„åº”ç”¨ï¼Œç„¶ååˆ‡æ¢æµé‡åˆ°æ–°ç‰ˆæœ¬ï¼‰ã€‚

#### Pod

- **å®šä¹‰ä¸ç»„æˆ**
  - Pod æ˜¯ Kubernetes ä¸­æœ€å°çš„éƒ¨ç½²å•å…ƒï¼Œå®ƒå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç´§å¯†ç›¸å…³çš„å®¹å™¨ã€‚è¿™äº›å®¹å™¨åœ¨åŒä¸€ä¸ª Pod å†…å…±äº«ç½‘ç»œå‘½åç©ºé—´ã€å­˜å‚¨å·ç­‰èµ„æºã€‚é€šå¸¸ï¼Œä¸€ä¸ª Pod å†…çš„å®¹å™¨ä¼šååŒå·¥ä½œæ¥å®Œæˆä¸€ä¸ªå®Œæ•´çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ä¸€ä¸ªåŒ…å«åº”ç”¨å®¹å™¨å’Œæ—¥å¿—æ”¶é›†å®¹å™¨çš„ Podã€‚
  - ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªç®€å•çš„ Web åº”ç”¨åœºæ™¯ä¸­ï¼Œä¸€ä¸ª Pod å¯èƒ½åŒ…å«ä¸€ä¸ªè¿è¡Œ Web æœåŠ¡å™¨ï¼ˆå¦‚ Nginxï¼‰çš„å®¹å™¨å’Œä¸€ä¸ªç”¨äºæ”¶é›† Nginx æ—¥å¿—çš„å®¹å™¨ã€‚è¿™ä¸¤ä¸ªå®¹å™¨å…±äº«åŒä¸€ä¸ªç½‘ç»œæ¥å£ï¼Œä½¿å¾—æ—¥å¿—æ”¶é›†å®¹å™¨å¯ä»¥æ–¹ä¾¿åœ°ä» Web æœåŠ¡å™¨å®¹å™¨è·å–æ—¥å¿—ä¿¡æ¯ã€‚
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**
  - Pod æœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»åˆ›å»ºã€è¿è¡Œåˆ°é”€æ¯ã€‚åœ¨åˆ›å»ºé˜¶æ®µï¼ŒKubelet ä¼šæ ¹æ® API Server ä¸‹å‘çš„ Pod é…ç½®ä¿¡æ¯ï¼Œä¸‹è½½å®¹å™¨é•œåƒå¹¶å¯åŠ¨å®¹å™¨ã€‚åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒKubelet ä¼šå®šæœŸæ£€æŸ¥å®¹å™¨çš„å¥åº·çŠ¶æ€ï¼Œé€šè¿‡å®¹å™¨çš„å¥åº·æ£€æŸ¥æœºåˆ¶ï¼ˆå¦‚ HTTP å¥åº·æ£€æŸ¥ã€å‘½ä»¤è¡Œæ£€æŸ¥ç­‰ï¼‰æ¥åˆ¤æ–­å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚å¦‚æœå®¹å™¨å‡ºç°æ•…éšœï¼ŒKubelet ä¼šæ ¹æ®é…ç½®å°è¯•é‡å¯å®¹å™¨ã€‚å½“ Pod éœ€è¦è¢«é”€æ¯æ—¶ï¼ŒKubelet ä¼šå…ˆåœæ­¢å®¹å™¨ï¼Œç„¶åæ¸…ç†ç›¸å…³çš„èµ„æºã€‚
  - å‡è®¾ä¸€ä¸ª Pod ä¸­çš„ Web æœåŠ¡å™¨å®¹å™¨åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°äº†å†…å­˜æ³„æ¼ï¼Œå¯¼è‡´æ— æ³•æ­£å¸¸å“åº”è¯·æ±‚ã€‚Kubelet é€šè¿‡å¥åº·æ£€æŸ¥å‘ç°è¿™ä¸ªé—®é¢˜åï¼Œä¼šæ ¹æ®é‡å¯ç­–ç•¥ï¼ˆå¦‚æ€»æ˜¯é‡å¯ã€ä¸€å®šæ¬¡æ•°åä¸å†é‡å¯ç­‰ï¼‰æ¥å†³å®šæ˜¯å¦é‡å¯è¯¥å®¹å™¨ï¼Œä»¥æ¢å¤ Web æœåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚
- **é…ç½®æ–‡ä»¶ç¤ºä¾‹**
  
  åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`apiVersion`æŒ‡å®šäº† Kubernetes API çš„ç‰ˆæœ¬ï¼Œ`kind`è¡¨æ˜è¿™æ˜¯ä¸€ä¸ª Pod èµ„æºã€‚`metadata`éƒ¨åˆ†åŒ…å«äº† Pod çš„åç§°ï¼ˆ`my - pod`ï¼‰å’Œæ ‡ç­¾ï¼ˆ`app: my - app`ï¼‰ï¼Œæ ‡ç­¾ç”¨äºå¯¹ Pod è¿›è¡Œåˆ†ç±»å’Œé€‰æ‹©ã€‚`spec`éƒ¨åˆ†è¯¦ç»†æè¿°äº† Pod ä¸­çš„å®¹å™¨ï¼ŒåŒ…æ‹¬å®¹å™¨åç§°ã€å®¹å™¨é•œåƒå’Œå®¹å™¨æš´éœ²çš„ç«¯å£ç­‰ä¿¡æ¯ã€‚
  
  ```yaml
  apiVersion: v1
  kind: Pod
  metadata:
    name: my - pod
    labels:
      app: my - app
  spec:
    containers:
    - name: my - web - container
      image: nginx:latest
      ports:
      - containerPort: 80
    - name: my - log - container
      image: fluentd:latest
  ```

#### Service

- **æœåŠ¡å‘ç°ä¸è®¿é—®æŠ½è±¡**
  - Service æ˜¯ä¸€ç§æŠ½è±¡çš„èµ„æºï¼Œå®ƒä¸ºä¸€ç»„ Pod æä¾›äº†ä¸€ä¸ªç¨³å®šçš„è®¿é—®å…¥å£ã€‚åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼ŒPod çš„ IP åœ°å€å¯èƒ½ä¼šå› ä¸ºå„ç§åŸå› ï¼ˆå¦‚ Pod çš„é‡æ–°è°ƒåº¦ã€é‡å¯ç­‰ï¼‰è€Œå‘ç”Ÿå˜åŒ–ã€‚Service é€šè¿‡ä¸ºè¿™ç»„ Pod åˆ†é…ä¸€ä¸ªå›ºå®šçš„ ClusterIP æˆ–è€…é€šè¿‡å…¶ä»–è®¿é—®æ–¹å¼ï¼ˆå¦‚ NodePortã€LoadBalancerï¼‰ï¼Œä½¿å¾—å…¶ä»– Pod æˆ–è€…å¤–éƒ¨å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è¿™ä¸ªç¨³å®šçš„åœ°å€æ¥è®¿é—®è¿™äº› Podã€‚
  - ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªåç«¯ç”±å¤šä¸ªæ•°æ®åº“ Pod ç»„æˆçš„æ•°æ®åº“æœåŠ¡ï¼Œå‰ç«¯çš„åº”ç”¨ Pod å¯ä»¥é€šè¿‡è®¿é—®æ•°æ®åº“æœåŠ¡çš„ Service åœ°å€æ¥ä¸æ•°æ®åº“è¿›è¡Œé€šä¿¡ï¼Œè€Œä¸ç”¨æ‹…å¿ƒå…·ä½“æŸä¸ªæ•°æ®åº“ Pod çš„ IP åœ°å€å˜åŒ–ã€‚
- **ç±»å‹ä¸ç”¨é€”**
  - Service æœ‰å¤šç§ç±»å‹ï¼Œå¦‚ ClusterIPï¼ˆé»˜è®¤ç±»å‹ï¼‰ï¼Œè¿™ç§ç±»å‹çš„ Service åªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œç”¨äºé›†ç¾¤å†…çš„æœåŠ¡ä¹‹é—´çš„é€šä¿¡ï¼›NodePort ç±»å‹çš„ Service ä¼šåœ¨æ¯ä¸ª Worker èŠ‚ç‚¹ä¸Šå¼€æ”¾ä¸€ä¸ªæŒ‡å®šçš„ç«¯å£ï¼Œå¤–éƒ¨å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è®¿é—®èŠ‚ç‚¹çš„ IP åœ°å€å’Œè¿™ä¸ªç«¯å£æ¥è®¿é—®æœåŠ¡ï¼›LoadBalancer ç±»å‹çš„ Service åˆ™é€šå¸¸ç”¨äºåœ¨äº‘ç¯å¢ƒä¸­ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨æ¥å°†å¤–éƒ¨æµé‡åˆ†é…åˆ°åç«¯çš„ Pod ä¸Šã€‚
  - åœ¨äº‘ç¯å¢ƒä¸­éƒ¨ç½²ä¸€ä¸ª Web åº”ç”¨æ—¶ï¼Œå¦‚æœä½¿ç”¨ LoadBalancer ç±»å‹çš„ Serviceï¼Œäº‘æœåŠ¡æä¾›å•†ï¼ˆå¦‚ AWSã€Azure ç­‰ï¼‰ä¼šè‡ªåŠ¨ä¸ºè¿™ä¸ªæœåŠ¡åˆ›å»ºä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Œå°†äº’è”ç½‘ç”¨æˆ·çš„è¯·æ±‚å‡åŒ€åœ°åˆ†é…åˆ°åç«¯çš„ Web åº”ç”¨ Pod ä¸Šï¼Œä»è€Œæé«˜åº”ç”¨çš„å¯ç”¨æ€§å’Œæ€§èƒ½ã€‚
- **é…ç½®æ–‡ä»¶ç¤ºä¾‹**
  
  åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`apiVersion`å’Œ`kind`å®šä¹‰äº†è¿™æ˜¯ä¸€ä¸ª Service èµ„æºã€‚`metadata`åŒ…å«äº† Service çš„åç§°ã€‚`spec`éƒ¨åˆ†çš„`selector`å­—æ®µç”¨äºé€‰æ‹©å…³è”çš„ Podï¼Œè¿™é‡Œä¼šé€‰æ‹©å¸¦æœ‰`app: my - app`æ ‡ç­¾çš„ Podã€‚`ports`å­—æ®µå®šä¹‰äº† Service çš„ç«¯å£ä¿¡æ¯ï¼ŒåŒ…æ‹¬åè®®ï¼ˆTCPï¼‰ã€Service æš´éœ²çš„ç«¯å£ï¼ˆ`port`ï¼Œè¿™é‡Œæ˜¯ 80ï¼‰å’Œç›®æ ‡ Pod çš„ç«¯å£ï¼ˆ`targetPort`ï¼Œè¿™é‡Œæ˜¯ 8080ï¼‰ã€‚`type`æŒ‡å®šäº† Service çš„ç±»å‹ä¸º`ClusterIP`ï¼Œè¡¨ç¤ºè¿™ä¸ª Service åªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚
  
  > - **typeç±»å‹**ï¼š
  >   - **ClusterIPï¼ˆé»˜è®¤ï¼‰**ï¼šè¿™ç§ç±»å‹çš„ Service åªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œç”¨äºé›†ç¾¤å†…çš„æœåŠ¡ä¹‹é—´çš„é€šä¿¡ã€‚å®ƒä¼šåœ¨é›†ç¾¤å†…éƒ¨çš„è™šæ‹Ÿ IP ç½‘ç»œä¸­åˆ†é…ä¸€ä¸ª IP åœ°å€ï¼Œåªæœ‰é›†ç¾¤å†…çš„ Pod å¯ä»¥é€šè¿‡è¿™ä¸ª IP åœ°å€è®¿é—®åç«¯çš„ Podã€‚
  >   - **NodePort**ï¼šé™¤äº† ClusterIPï¼ŒNodePort è¿˜ä¼šåœ¨æ¯ä¸ª Worker èŠ‚ç‚¹ä¸Šå¼€æ”¾ä¸€ä¸ªæŒ‡å®šçš„ç«¯å£ï¼ˆèŒƒå›´æ˜¯ 30000 - 32767ï¼‰ã€‚å¤–éƒ¨å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è®¿é—®èŠ‚ç‚¹çš„ IP åœ°å€å’Œè¿™ä¸ªç«¯å£æ¥è®¿é—®æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ª NodePort ç±»å‹çš„ Service çš„èŠ‚ç‚¹ç«¯å£æ˜¯ 30080ï¼Œå¤–éƒ¨å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è®¿é—®`http://<worker - node - ip>:30080`æ¥è®¿é—®æœåŠ¡ã€‚
  >   - **LoadBalancer**ï¼šé€šå¸¸ç”¨äºåœ¨äº‘ç¯å¢ƒä¸­ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨æ¥å°†å¤–éƒ¨æµé‡åˆ†é…åˆ°åç«¯çš„ Pod ä¸Šã€‚äº‘æœåŠ¡æä¾›å•†ï¼ˆå¦‚ AWSã€Azure ç­‰ï¼‰ä¼šæ ¹æ® Service çš„é…ç½®åˆ›å»ºç›¸åº”çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œè¿™ä¸ªè´Ÿè½½å‡è¡¡å™¨ä¼šå°†æµé‡è½¬å‘åˆ°åç«¯çš„ NodePort æˆ–è€… ClusterIP æœåŠ¡ä¸Šã€‚
  
  ```yaml
  apiVersion: v1
  kind: Service
  metadata:
    name: my - service
  spec:
    selector:
      app: my - app
    ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
    type: ClusterIPluentd:latest
  ```

#### Deployment

- **åº”ç”¨éƒ¨ç½²ä¸æ›´æ–°ç®¡ç†**
  - Deployment æ˜¯ç”¨äºç®¡ç†æ— çŠ¶æ€åº”ç”¨çš„éƒ¨ç½²å’Œæ›´æ–°çš„èµ„æºå¯¹è±¡ã€‚å®ƒå…è®¸ç”¨æˆ·å®šä¹‰åº”ç”¨çš„æœŸæœ›çŠ¶æ€ï¼Œå¦‚ Pod çš„å‰¯æœ¬æ•°é‡ã€å®¹å™¨é•œåƒç‰ˆæœ¬ç­‰ã€‚åœ¨éƒ¨ç½²åº”ç”¨æ—¶ï¼ŒDeployment ä¼šæ ¹æ®ç”¨æˆ·å®šä¹‰çš„é…ç½®åˆ›å»ºæŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬ã€‚
  - ä¾‹å¦‚ï¼Œå½“è¦éƒ¨ç½²ä¸€ä¸ªæ–°çš„å¾®æœåŠ¡åº”ç”¨æ—¶ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª Deployment å¯¹è±¡ï¼ŒæŒ‡å®šè¦ä½¿ç”¨çš„å®¹å™¨é•œåƒã€å‰¯æœ¬æ•°é‡ï¼ˆå¦‚ 3 ä¸ªå‰¯æœ¬ï¼‰ç­‰ä¿¡æ¯ã€‚Deployment ä¼šè‡ªåŠ¨å°† 3 ä¸ª Pod å‰¯æœ¬éƒ¨ç½²åˆ°åˆé€‚çš„èŠ‚ç‚¹ä¸Šï¼Œä½¿å¾—åº”ç”¨èƒ½å¤Ÿä»¥å¤šå‰¯æœ¬çš„æ–¹å¼è¿è¡Œï¼Œæé«˜å¯ç”¨æ€§ã€‚
- **æ›´æ–°ç­–ç•¥ä¸ç‰ˆæœ¬æ§åˆ¶**
  - Deployment æä¾›äº†å¤šç§æ›´æ–°ç­–ç•¥ï¼Œå¦‚æ»šåŠ¨æ›´æ–°å’Œè“ç»¿æ›´æ–°ã€‚æ»šåŠ¨æ›´æ–°æ˜¯æœ€å¸¸ç”¨çš„ç­–ç•¥ï¼Œå®ƒä¼šé€æ­¥æ›¿æ¢æ—§ç‰ˆæœ¬çš„ Pod ä¸ºæ–°ç‰ˆæœ¬ï¼Œåœ¨æ›´æ–°è¿‡ç¨‹ä¸­å¯ä»¥æ§åˆ¶æ›´æ–°çš„é€Ÿåº¦å’ŒåŒæ—¶æ›´æ–°çš„ Pod æ•°é‡ï¼Œä»¥ç¡®ä¿åº”ç”¨çš„å¯ç”¨æ€§ã€‚è“ç»¿æ›´æ–°åˆ™æ˜¯å…ˆåˆ›å»ºä¸€å¥—å®Œæ•´çš„æ–°ç‰ˆæœ¬åº”ç”¨ç¯å¢ƒï¼Œç„¶åä¸€æ¬¡æ€§å°†æµé‡åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬ã€‚
  - å‡è®¾ä¸€ä¸ª Web åº”ç”¨éœ€è¦è¿›è¡Œç‰ˆæœ¬æ›´æ–°ï¼Œä½¿ç”¨æ»šåŠ¨æ›´æ–°ç­–ç•¥æ—¶ï¼ŒDeployment ä¼šå…ˆåˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬çš„ Podï¼Œç­‰å¾…å®ƒæˆåŠŸè¿è¡Œåï¼Œå†åœæ­¢ä¸€ä¸ªæ—§ç‰ˆæœ¬çš„ Podã€‚å¦‚æ­¤å¾ªç¯ï¼Œç›´åˆ°æ‰€æœ‰æ—§ç‰ˆæœ¬çš„ Pod éƒ½è¢«æ›¿æ¢ä¸ºæ–°ç‰ˆæœ¬ï¼Œè¿™æ ·å¯ä»¥åœ¨ä¸ä¸­æ–­æœåŠ¡çš„æƒ…å†µä¸‹å®Œæˆåº”ç”¨çš„æ›´æ–°ã€‚
- **é…ç½®æ–‡ä»¶ç¤ºä¾‹**
  
  åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`apiVersion`å’Œ`kind`å®šä¹‰äº†è¿™æ˜¯ä¸€ä¸ª Deployment èµ„æºã€‚`metadata`åŒ…å«äº† Deployment çš„åç§°ã€‚`spec`éƒ¨åˆ†çš„`replicas`å­—æ®µå®šä¹‰äº†æœŸæœ›çš„ Pod å‰¯æœ¬æ•°é‡ä¸º 3 ä¸ªã€‚`selector`ç”¨äºé€‰æ‹©å…³è”çš„ Podï¼Œè¿™é‡Œä¼šé€‰æ‹©å¸¦æœ‰`app: my - app`æ ‡ç­¾çš„ Podã€‚`template`éƒ¨åˆ†å®šä¹‰äº† Pod çš„æ¨¡æ¿ï¼ŒåŒ…æ‹¬ Pod çš„æ ‡ç­¾å’Œå®¹å™¨ä¿¡æ¯ã€‚è¿™ä¸ªæ¨¡æ¿ç”¨äºåˆ›å»ºå’Œæ›´æ–° Podã€‚
  
  > - **æ›´æ–°ç­–ç•¥**ï¼š
  >   - **æ»šåŠ¨æ›´æ–°**ï¼šè¿™æ˜¯æœ€å¸¸ç”¨çš„æ›´æ–°ç­–ç•¥ã€‚åœ¨æ»šåŠ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼ŒDeployment ä¼šé€æ­¥æ›¿æ¢æ—§ç‰ˆæœ¬çš„ Pod ä¸ºæ–°ç‰ˆæœ¬ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥å…ˆåˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬çš„ Podï¼Œç­‰å¾…è¿™ä¸ªæ–° Pod æˆåŠŸè¿è¡Œå¹¶é€šè¿‡å¥åº·æ£€æŸ¥åï¼Œå†åœæ­¢ä¸€ä¸ªæ—§ç‰ˆæœ¬çš„ Podã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåº”ç”¨çš„æœåŠ¡ä¸ä¼šä¸­æ–­ï¼Œå¹¶ä¸”å¯ä»¥æ§åˆ¶åŒæ—¶æ›´æ–°çš„ Pod æ•°é‡å’Œæ›´æ–°çš„é€Ÿåº¦ã€‚å¯ä»¥é€šè¿‡è®¾ç½®`maxSurge`ï¼ˆæœ€å¤šæ¯”æœŸæœ›å‰¯æœ¬æ•°å¤šå‡ºçš„ Pod æ•°é‡ï¼‰å’Œ`maxUnavailable`ï¼ˆæœ€å¤šå…è®¸ä¸å¯ç”¨çš„ Pod æ•°é‡ï¼‰ç­‰å‚æ•°æ¥æ§åˆ¶æ»šåŠ¨æ›´æ–°çš„è¿‡ç¨‹ã€‚
  >   - **è“ç»¿æ›´æ–°**ï¼šè¿™ç§æ›´æ–°ç­–ç•¥ç›¸å¯¹å¤æ‚ä¸€äº›ã€‚é¦–å…ˆä¼šåˆ›å»ºä¸€å¥—å®Œæ•´çš„æ–°ç‰ˆæœ¬åº”ç”¨ç¯å¢ƒï¼ˆåŒ…æ‹¬æ–°çš„ Pod ç­‰ï¼‰ï¼Œç„¶åé€šè¿‡åˆ‡æ¢æµé‡çš„æ–¹å¼å°†ç”¨æˆ·è¯·æ±‚ä»æ—§ç‰ˆæœ¬çš„åº”ç”¨è½¬ç§»åˆ°æ–°ç‰ˆæœ¬ã€‚è¿™ç§ç­–ç•¥å¯ä»¥å®ç°å¿«é€Ÿçš„ç‰ˆæœ¬åˆ‡æ¢ï¼Œä½†éœ€è¦æ›´å¤šçš„èµ„æºæ¥åŒæ—¶ç»´æŠ¤æ—§ç‰ˆæœ¬å’Œæ–°ç‰ˆæœ¬çš„åº”ç”¨ç¯å¢ƒã€‚
  
  ```yaml
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: my - deployment
  spec:
    replicas: 3
    selector:
      matchLabels:
        app: my - app
    template:
      metadata:
        labels:
          app: my - app
      spec:
        containers:
        - name: my - container
          image: my - app:v1
  ```



## minikube

Minikube æ˜¯ä¸€ä¸ªç”¨äºåœ¨æœ¬åœ°è®¡ç®—æœºä¸Šè¿è¡Œå•èŠ‚ç‚¹ Kubernetes é›†ç¾¤çš„å·¥å…·ã€‚å®ƒä¸»è¦ç”¨äºå¼€å‘ã€æµ‹è¯•å’Œå­¦ä¹  Kubernetesï¼Œè€Œä¸éœ€è¦è®¿é—®ä¸€ä¸ªå®Œæ•´çš„ Kubernetes é›†ç¾¤ã€‚Minikube å¯ä»¥åœ¨è™šæ‹Ÿæœºæˆ–å®¹å™¨ä¸­è¿è¡Œ Kubernetesï¼Œæ”¯æŒå¤šç§è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå¦‚ VirtualBoxã€VMwareã€Hyper-Vã€KVM å’Œ Dockerã€‚

### å®‰è£…ä½¿ç”¨

> éœ€è¦æå‰å®‰è£…å¥½ Docker

#### å¸¸ç”¨å‘½ä»¤

> å‚è€ƒèµ„æ–™ï¼š[ğŸ’½ å®‰è£… Kubernetes é›†ç¾¤ - K8S æ•™ç¨‹](https://k8s.easydoc.net/docs/dRiQjyTY/28366845/6GiNOzyZ/nd7yOvdY)

```shell
# å¯åŠ¨é›†ç¾¤
minikube start
# æŸ¥çœ‹èŠ‚ç‚¹ã€‚kubectl æ˜¯ä¸€ä¸ªç”¨æ¥è·Ÿ K8S é›†ç¾¤è¿›è¡Œäº¤äº’çš„å‘½ä»¤è¡Œå·¥å…·
kubectl get node
# åœæ­¢é›†ç¾¤
minikube stop
# æ¸…ç©ºé›†ç¾¤
minikube delete --all
# å®‰è£…é›†ç¾¤å¯è§†åŒ– Web UI æ§åˆ¶å°
minikube dashboard
```

##### å¯åŠ¨ Minikube

1. **å¯åŠ¨ Minikube**ï¼š
   
   - ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ Minikube é›†ç¾¤ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒMinikube ä¼šä½¿ç”¨ VirtualBox ä½œä¸ºè™šæ‹ŸåŒ–å·¥å…·ã€‚
   
   <BASH>
   
   ```
   minikube start
   -- æˆ–è€…æŒ‡å®šé•œåƒæºï¼ˆä¸æŒ‡å®šçš„è¯ï¼Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°æ‹‰ä¸åˆ°é•œåƒçš„æƒ…å†µï¼‰
   minikube start --registry-mirror="https://docker.m.daocloud.io"
   ```

2. **æŒ‡å®šè™šæ‹ŸåŒ–å·¥å…·**ï¼š
   
   - å¦‚æœéœ€è¦ä½¿ç”¨å…¶ä»–è™šæ‹ŸåŒ–å·¥å…·ï¼Œå¯ä»¥ä½¿ç”¨Â `--driver`Â å‚æ•°æŒ‡å®šã€‚
   
   <BASH>
   
   ```
   minikube start --driver=hyperkit
   ```

3. **æŸ¥çœ‹é›†ç¾¤çŠ¶æ€**ï¼š
   
   - ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ Minikube é›†ç¾¤çš„çŠ¶æ€ã€‚
   
   <BASH>
   
   ```
   minikube status
   ```

##### ä½¿ç”¨ Minikube

1. **éƒ¨ç½²åº”ç”¨**ï¼š
   
   - ä½¿ç”¨ kubectl éƒ¨ç½²åº”ç”¨ã€‚ä¾‹å¦‚ï¼Œéƒ¨ç½²ä¸€ä¸ªç®€å•çš„ Nginx åº”ç”¨ã€‚
   
   <BASH>
   
   ```
   kubectl create deployment nginx --image=nginx
   ```

2. **æš´éœ²æœåŠ¡**ï¼š
   
   - ä½¿ç”¨ kubectl æš´éœ²æœåŠ¡ï¼Œä½¿å…¶å¯ä»¥é€šè¿‡å¤–éƒ¨è®¿é—®ã€‚
   
   <BASH>
   
   ```
   kubectl expose deployment nginx --type=NodePort --port=80
   ```

3. **è®¿é—®åº”ç”¨**ï¼š
   
   - ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·å–æœåŠ¡çš„ URLï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­è®¿é—®ã€‚
   
   <BASH>
   
   ```
   minikube service nginx
   ```

4. **æŸ¥çœ‹æ—¥å¿—**ï¼š
   
   - ä½¿ç”¨ kubectl æŸ¥çœ‹ Pod çš„æ—¥å¿—ã€‚
   
   <BASH>
   
   ```
   kubectl logs <pod-name>
   ```

5. **è¿›å…¥ Pod**ï¼š
   
   - ä½¿ç”¨ kubectl è¿›å…¥ Pod çš„å®¹å™¨ã€‚
   
   <BASH>
   
   ```
   kubectl exec -it <pod-name> -- /bin/bash
   ```

##### åœæ­¢å’Œåˆ é™¤ Minikube

1. **åœæ­¢ Minikube**ï¼š
   
   - ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœæ­¢ Minikube é›†ç¾¤ã€‚
   
   <BASH>
   
   ```
   minikube stop
   ```

2. **åˆ é™¤ Minikube**ï¼š
   
   - ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ é™¤ Minikube é›†ç¾¤ã€‚
   
   <BASH>
   
   ```
   minikube delete
   ```

##### æ’ä»¶å’Œæ‰©å±•

1. **å¯ç”¨æ’ä»¶**ï¼š
   
   - Minikube æ”¯æŒå¤šç§æ’ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ç”¨æ’ä»¶ã€‚
   
   <BASH>
   
   ```
   minikube addons enable ingress
   ```

2. **æŸ¥çœ‹æ’ä»¶åˆ—è¡¨**ï¼š
   
   - ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å¯ç”¨çš„æ’ä»¶åˆ—è¡¨ã€‚
   
   <BASH>
   
   ```
   minikube addons list
   ```
